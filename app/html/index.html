<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recordings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/app.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
</head>
<body>
<div class="d-flex" id="wrapper">
    <div class="bg-light border-right" id="sidebar-wrapper">
        <div class="sidebar-heading">Timelapse</div>
        <div class="list-group list-group-flush">
            <a href="index.html" class="list-group-item list-group-item-action active">Recordings</a>
            <a href="timelapse.html" class="list-group-item list-group-item-action">Profiles</a>
            <a href="sunevents.html" class="list-group-item list-group-item-action">Sun Events</a>
            <a href="about.html" class="list-group-item list-group-item-action">About</a>
        </div>
    </div>
    
    <div id="page-content-wrapper" class="p-0">
        <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
            <span class="acap_name"></span>
        </nav>

        <div class="container-fluid">
            <h1>Recordings</h1>
            <div class="table-responsive mt-4">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Profile Name</th>
                            <th>Images</th>
                            <th>First Capture</th>
                            <th>Last Capture</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recordings-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="inspectModal" tabindex="-1" aria-labelledby="inspectModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="inspectModalLabel">Inspect Images</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <img id="inspectImage" class="img-fluid mb-3" alt="Inspection Image">
                    <div class="d-flex justify-content-between align-items-center">
                        <button id="prevButton" class="btn btn-outline-primary">&lt;</button>
                        <input type="range" class="form-range mx-2" id="imageSlider" min="1" max="1" value="1">
                        <button id="nextButton" class="btn btn-outline-primary">&gt;</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="downloadButton">Download</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    let currentProfileId = null;
    let currentImageIndex = 1;
    let totalImages = 0;

    // Fetch app details
    $.ajax({
        type: 'GET',
        url: 'app',
        dataType: 'json',
        cache: false,
        success: function(app) {
            document.title = app.manifest.acapPackageConf.setup.friendlyName;
            $('.acap_name').text(app.manifest.acapPackageConf.setup.friendlyName);
        }
    });

    function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        return new Date(timestamp).toLocaleString();
    }

    // Fetch both profiles and recordings
    Promise.all([
        $.ajax({ url: 'timelapse', type: 'GET' }),
        $.ajax({ url: 'recordings', type: 'GET' })
    ]).then(function([profiles, recordings]) {
        const tbody = $('#recordings-list');
        tbody.empty();

        Object.entries(recordings).forEach(([id, recording]) => {
            const profile = profiles.find(p => p.id === id) || { name: 'Unknown Profile' };
            var tr = '<tr>';
            tr += '<td>' + profile.name + '</td>';
            tr += '<td>' + recording.images + '</td>';
            tr += '<td>' + formatDate(recording.first) + '</td>';
            tr += '<td>' + formatDate(recording.last) + '</td>';
            tr += '<td>';
            tr += '<button class="btn btn-sm btn-primary me-1" onclick="inspectRecording(\'' + id + '\')">Inspect</button>';
            tr += '<button class="btn btn-sm btn-success me-1" onclick="exportRecording(\'' + id + '\')">Export</button>';
            tr += '<button class="btn btn-sm btn-danger" onclick="flushRecording(\'' + id + '\')">Flush</button>';
            tr += '</td>';
            tr += '</tr>';
            tbody.append(tr);
        });
    });

    function loadImage(index) {
        $('#inspectImage').attr('src', 'image?id=' + currentProfileId + '&index=' + index);
        $('#imageSlider').val(index);
        currentImageIndex = index;
    }

    window.inspectRecording = function(id) {
        currentProfileId = id;
        currentImageIndex = 1;
        
        $.ajax({
            url: 'recordings?id=' + id,
            type: 'GET',
            success: function(data) {
                totalImages = data.images;
                $('#imageSlider').attr('max', totalImages);
                loadImage(1);
                $('#inspectModal').modal('show');
            }
        });
    };

    window.exportRecording = function(id) {
        console.log('Export:', id);
    };

    window.flushRecording = function(id) {
        if (!confirm('Are you sure you want to flush this recording?')) return;
        
        $.ajax({
            type: 'DELETE',
            url: 'recordings?id=' + id,
            success: function() {
                location.reload();
            }
        });
    };

    $('#prevButton').click(function() {
        if (currentImageIndex > 1) {
            loadImage(currentImageIndex - 1);
        }
    });

    $('#nextButton').click(function() {
        if (currentImageIndex < totalImages) {
            loadImage(currentImageIndex + 1);
        }
    });

    $('#imageSlider').on('input', function() {
        loadImage(parseInt($(this).val()));
    });

    $('#downloadButton').click(function() {
        window.location.href = 'download?id=' + currentProfileId + '&index=' + currentImageIndex;
    });
});
</script>
</body>
</html>
